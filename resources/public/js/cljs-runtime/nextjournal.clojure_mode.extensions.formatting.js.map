{"version":3,"sources":["nextjournal/clojure_mode/extensions/formatting.cljs"],"mappings":"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","names":["nextjournal.clojure-mode.extensions.formatting/spaces","state","n","js/module$node_modules$$codemirror$language$dist$index_cjs","p__52127","map__52128","cljs.core/PROTOCOL_SENTINEL","cljs.core.apply","cljs.core/hash-map","obj52133","k52134","obj52135","applied-science.js-interop.impl/in?*","js/undefined","nextjournal.clojure-mode.extensions.formatting/indent-node-props","type-name","type","p__52140","map__52141","obj52143","k52144","obj52145","obj52147","k52148","obj52151","obj52153","k52154","obj52157","obj52160","k52161","obj52162","context","pos","unit","node","cljs.core._EQ_","nextjournal.clojure-mode.node/coll-type?","G__52170","nextjournal.clojure-mode.node/down","nextjournal.clojure-mode.node/end","and__4221__auto__","G__52174","fexpr__52173","G__52175","nextjournal.clojure-mode.node/right","nextjournal.clojure-mode.node/name","nextjournal.clojure-mode.extensions.formatting/props","js/module$node_modules$$codemirror$language$dist$index_cjs.indentNodeProp","nextjournal.clojure-mode.extensions.formatting/get-indentation","js/module$node_modules$$codemirror$language$dist$index_cjs.getIndentation","nextjournal.clojure-mode.extensions.formatting/make-indent-context","js/module$node_modules$$codemirror$language$dist$index_cjs.IndentContext","nextjournal.clojure-mode.extensions.formatting/indent-all","nextjournal.clojure-mode.util/update-lines","from","content","line-num","current-indent","indent","nextjournal.clojure-mode.util/guard","cljs.core/complement","cljs.core/neg?","G__52189","js/Error","cljs.core/compare","nextjournal.clojure-mode.extensions.formatting/expected-space","n1","n2","nextjournal.clojure-mode.node/start-edge-type?","nextjournal.clojure-mode.node/prefix-edge-type?","nextjournal.clojure-mode.node/end-edge-type?","nextjournal.clojure-mode.node/same-edge-type?","nextjournal.clojure-mode.extensions.formatting/space-changes","to","nodes","nextjournal.clojure-mode.node/terminal-nodes","nextjournal.clojure_mode.node.tree","p1__52200#","cljs.core.filter","nextjournal.clojure-mode.node/start","cljs.core/reverse","trim?","G__52210","cljs.core/first","cljs.core.partition","cljs.core.reduce","p__52212","vec__52214","map__52219","cljs.core.nth","obj52222","k52223","obj52224","obj52225","k52226","obj52227","obj52228","k52229","obj52230","map__52220","obj52232","k52233","obj52234","obj52235","k52236","obj52237","obj52239","k52240","obj52241","out","start2","end2","start1","end1","expected","actual","G__52242","array52243","array52244","nextjournal.clojure-mode.extensions.formatting/into-arr","arr","items","seq__52245","cljs.core/seq","chunk__52246","count__52247","i__52248","temp__5754__auto__","cljs.core/chunked-seq?","c__4649__auto__","cljs.core/chunk-first","cljs.core/chunk-rest","cljs.core/count","cljs.core/next","i","nextjournal.clojure-mode.extensions.formatting/format-line","indent-context","text","changes","format-spaces?","indentation-change","G__52249","space-changes","G__52250","array52251","nextjournal.clojure-mode.extensions.formatting/format-selection","nextjournal.clojure-mode.util/update-selected-lines","p__52252","map__52253","obj52255","k52256","obj52257","obj52258","k52259","obj52260","obj52261","k52262","obj52263","line","number","range","nextjournal.clojure-mode.extensions.formatting/format-all","nextjournal.clojure-mode.extensions.formatting/format-transaction","tr","origin","nextjournal.clojure-mode.util/get-user-event-annotation","temp__5752__auto__","G__52264","nextjournal.clojure-mode.util/iter-changed-lines","obj52265","obj52266","nextjournal.clojure-mode.extensions.formatting/format","nextjournal.clojure-mode.util/something-selected?","nextjournal.clojure-mode.extensions.formatting/prefix-all","prefix","_","nextjournal.clojure-mode.extensions.formatting/ext-format-changed-lines","js/module$node_modules$$codemirror$state$dist$index_cjs.EditorState"],"sourcesContent":["(ns nextjournal.clojure-mode.extensions.formatting\n  (:require [\"@codemirror/language\" :as language :refer [IndentContext]]\n            [\"@codemirror/state\" :refer [EditorState Transaction]]\n            [\"@codemirror/view\" :as view]\n            [\"@codemirror/commands\" :as commands]\n            [applied-science.js-interop :as j]\n            [nextjournal.clojure-mode.util :as u]\n            [nextjournal.clojure-mode.node :as n]))\n\n;; CodeMirror references\n;; IndentContext https://codemirror.net/6/docs/ref/#state.IndentContext\n;; indentation facet: https://codemirror.net/6/docs/ref/#state.EditorState%5Eindentation\n;; indentation commands: https://codemirror.net/6/docs/ref/#commands.indentSelection\n\n;; Clojure formatting reference\n;; https://tonsky.me/blog/clojurefmt/\n\n(defn spaces [^js state n]\n  (.indentString language state n))\n\n(j/defn indent-node-props [^:js {type-name :name :as type}]\n  (j/fn [^:js {:as ^js context :keys [pos unit node ^js state]}]\n    (cond (= \"Program\" type-name)\n          0\n\n          (n/coll-type? type)\n          (cond-> (.column context\n                           (-> node n/down n/end))\n            ;; start at the inner-left edge of the coll.\n            ;; if it's a list beginning with a symbol, add 1 space.\n            (and (= \"List\" type-name)\n                 (#{\"Operator\"\n                    \"DefLike\"} (some-> node\n                                       n/down\n                                       n/right\n                                       n/name)))\n            (+ 1))\n          :else -1)))\n\n(def props (.add language/indentNodeProp\n                 indent-node-props))\n\n(defn get-indentation [^js context pos]\n  (language/getIndentation (.-state context) pos))\n\n(defn make-indent-context [state]\n  (new IndentContext state))\n\n;; TODO: check if this is used at all\n(defn indent-all [^js state]\n  (let [context (make-indent-context state)]\n    (u/update-lines state\n                    (fn [from content line-num]\n                      (let [current-indent (-> (.exec #\"^\\s*\" content)\n                                               ^js (aget 0)\n                                               .-length)\n                            ^number indent (-> (get-indentation context from)\n                                               (u/guard (complement neg?)))]\n                        (when indent\n                          (case (compare indent current-indent)\n                            0 nil\n                            1 #js{:from (+ from current-indent)\n                                  :insert (spaces state (- indent ^number current-indent))}\n                            -1 #js{:from (+ from indent)\n                                   :to (+ from current-indent)})))))))\n\n(defn expected-space [n1 n2]\n  ;;  (prn :expected (map n/name [n1 n2]))\n  (if\n   (or\n    (n/start-edge-type? n1)\n    (n/prefix-edge-type? n1)\n    (n/end-edge-type? n2)\n    (n/same-edge-type? n2))\n    0\n    1))\n\n(defn space-changes [state from to]\n  (let [nodes (->> (n/terminal-nodes (n/tree state) from to)\n                   (filter #(or (<= from (n/start %) to)\n                                (<= from (n/end %) to)))\n                   (reverse))\n        trim? (some-> (first nodes) n/end (< to))]\n    (->> nodes\n         (partition 2 1)\n         (reduce (j/fn [out [^:js {n2 :type start2 :from end2 :to}\n                             ^:js {n1 :type start1 :from end1 :to}]]\n                   (let [expected (expected-space n1 n2)\n                         actual (- start2 end1)]\n                     (case (compare actual expected)\n                       0 out\n                       1 (j/push! out #js{:from (if (zero? expected)\n                                                  end1\n                                                  (inc end1))\n                                          :to start2})\n                       -1 (j/push! out #js{:from end1\n                                           :insert \" \"})\n                       out)))\n\n                 (if trim?\n                   (j/lit [{:from (-> nodes first n/end)\n                            :to to}])\n                   #js[])))))\n\n(defn into-arr [^js arr items]\n  (doseq [i items] (.push arr i))\n  arr)\n\n(defn format-line\n  \"Returns mutated `changes` array\"\n  [^js state\n   indent-context\n   from\n   text\n   line-num\n   changes\n   format-spaces?]\n  {:pre [(some? text)]}\n  (let [current-indent (-> ^js (aget (.exec #\"^\\s*\" text) 0)\n                           .-length)\n        ^number indent (-> (get-indentation indent-context from)\n                           (u/guard (complement neg?)))\n        indentation-change\n        (when indent\n          (case (compare indent current-indent)\n            0 nil\n            1 #js{:from (+ from current-indent)\n                  :insert (spaces state (- indent current-indent))}\n            -1 #js{:from (+ from indent)\n                   :to (+ from current-indent)}))\n        space-changes (when format-spaces?\n                        (space-changes state\n                                       (+ from current-indent)\n                                       (+ from (count text))))]\n    (cond-> changes\n      space-changes (into-arr space-changes)\n      indentation-change (j/push! indentation-change))))\n\n(defn format-selection\n  [^js state]\n  (let [context (make-indent-context state)]\n    (u/update-selected-lines state\n                             (j/fn [^:js {:as line :keys [from text number]} ^js changes ^js range]\n                               (format-line state context from text number changes true)))))\n\n(defn format-all [state]\n  (let [context (make-indent-context state)]\n    (u/update-lines state\n                    (fn [^number from ^string text line-num]\n                      (format-line state context from text line-num #js[] true)))))\n\n(defn format-transaction [^js tr]\n  (let [origin (u/get-user-event-annotation tr)]\n    (if-let [changes\n             (case origin\n               (\"input\"\n                \"delete\"\n                \"keyboardselection\"\n                \"pointerselection\"\n                \"cut\"\n                \"noformat\"\n                \"evalregion\") nil\n               \"format-selections\" (format-selection (.-state tr))\n               (let [state (.-state tr)\n                     context (make-indent-context state)]\n                 (u/iter-changed-lines tr\n                                       (fn [^js line ^js changes]\n                                         (format-line state context (.-from line) (.-text line) (.-number line) changes true)))))]\n      (.. tr -startState (update (j/assoc! changes :filter false)))\n      tr)))\n\n(defn format [state]\n  (if (u/something-selected? state)\n    (.update state (format-selection state))\n    (format-all state)))\n\n(defn prefix-all [prefix state]\n  (u/update-lines state\n    (fn [from _ _] #js{:from from :insert prefix})))\n\n(defn ext-format-changed-lines []\n                                        ; EditorState.transactionFilter.of\n  (.. EditorState -transactionFilter (of format-transaction)))\n"]}