{"version":3,"sources":["nextjournal/clojure_mode/extensions/selection_history.cljs"],"mappings":"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","names":["nextjournal.clojure-mode.extensions.selection-history/event-annotation","nextjournal.clojure-mode.util/user-event-annotation","nextjournal.clojure-mode.extensions.selection-history/second-last","arr","nextjournal.clojure-mode.extensions.selection-history/ser","selection","cljs.core.js__GT_clj","cljs.core.map","cljs.core.juxt","nextjournal.clojure-mode.extensions.selection-history/something-selected?","p1__52137#","cljs.core/some","cljs.core/not","nextjournal.clojure-mode.extensions.selection-history/selection-history-field","js/module$node_modules$$codemirror$state$dist$index_cjs.StateField","state","cljs.core/List","p__52146","map__52149","cljs.core/PROTOCOL_SENTINEL","cljs.core.apply","cljs.core/hash-map","map__52150","obj52155","k52156","obj52158","applied-science.js-interop.impl/in?*","js/undefined","obj52164","k52165","obj52166","obj52168","k52169","obj52172","stack","tr","docChanged","previous-position","cljs.core/first","cljs.core.keep_indexed","i","x","nextjournal.clojure-mode.selections/eq?","nextjournal.clojure-mode.util/get-user-event-annotation","vec__52177","seq__52178","cljs.core/seq","first__52179","cljs.core/next","f","more","cljs.core.drop","cljs.core/cons","cljs.core.assoc","nextjournal.clojure-mode.extensions.selection-history/extension","nextjournal.clojure-mode.extensions.selection-history/stack","nextjournal.clojure-mode.extensions.selection-history/grow-1","start","end","node","nextjournal.clojure-mode.node/nearest-touching","nextjournal.clojure-mode.node/ancestors","cljs.core.mapcat","nextjournal.clojure-mode.node/inner-span","cljs.core/identity","cljs.core.filter","p__52182","map__52183","obj52186","k52187","obj52188","obj52191","k52192","obj52193","a-start","a-end","nextjournal.clojure-mode.extensions.selection-history/selection-grow*","nextjournal.clojure_mode.util.update_ranges","p__52197","map__52199","obj52202","k52203","obj52204","obj52205","k52206","obj52207","obj52208","k52209","obj52211","range","from","to","empty","or__4223__auto__","G__52213","nextjournal.clojure_mode.node.balanced_range","G__52218","nextjournal.clojure-mode.node/range","nextjournal.clojure-mode.extensions.selection-history/selection-return*","temp__5752__auto__","cljs.core/second"],"sourcesContent":["(ns nextjournal.clojure-mode.extensions.selection-history\n  (:require [\"@codemirror/state\" :refer [Facet Extension EditorSelection StateField]]\n            [applied-science.js-interop :as j]\n            [nextjournal.clojure-mode.util :as u]\n            [nextjournal.clojure-mode.selections :as sel]\n            [nextjournal.clojure-mode.node :as n]))\n\n(def event-annotation (u/user-event-annotation \"selectionhistory\"))\n\n(defn second-last [^js arr]\n  (when (> (.-length arr) 1)\n    (aget arr (dec (.-length arr)))))\n\n(defn ser [selection]\n  (-> (.toJSON ^js selection)\n      (js->clj :keywordize-keys true)\n      :ranges\n      (->> (map (juxt :anchor :head)))))\n\n(defn something-selected? [^js selection]\n  (-> selection .-ranges (->> (some #(not (.-empty ^js %))))))\n\n(def selection-history-field\n  \"Stores selection history\"\n  (.define StateField\n           #js{:create (fn [^js state] (list {:selection (.-selection state)}))\n               :update\n                       (j/fn [stack ^:js {:as tr {:keys [selection]} :state :keys [docChanged]}]\n                         (let [previous-position\n                               (first (keep-indexed (fn [i x]\n                                                      (when (sel/eq? (:selection x) selection)\n                                                        i)) stack))]\n                           (cond\n\n                             ;; doc changed => clear log\n                             docChanged (list {:selection selection\n                                               :event     (u/get-user-event-annotation tr)})\n\n                             ;; no selection => clear stack to current position\n                             (not (something-selected? selection))\n                             (list {:selection selection\n                                    :event     (u/get-user-event-annotation tr)})\n\n                             ;; selection found in stack => move there\n                             previous-position\n                             (let [[f & more] (drop previous-position stack)]\n                               (cons (assoc f :prev-event (:event (first stack))) more))\n\n                             ;; transaction has selection => add to log\n                             :else\n                             (cons {:selection selection\n                                    :event     (u/get-user-event-annotation tr)}\n                                   stack))))}))\n\n(defn extension [] selection-history-field)\n\n(defn stack [^js state]\n  (.field state selection-history-field))\n\n(j/defn grow-1 [state start end]\n  (let [node (n/nearest-touching state end -1)]\n    (->> (n/ancestors node)\n         (mapcat (juxt n/inner-span identity))              ;; include inner-spans\n         (cons node)\n         (filter (j/fn [^:js {a-start :from a-end :to}]\n                   (and (<= a-start start)\n                        (>= a-end end)\n                        (not (and (== a-start start)\n                                  (== a-end end))))))\n         first)))\n\n(defn selection-grow* [^js state]\n  (u/update-ranges state\n                   #js{:annotations event-annotation}\n                   (j/fn [^:js {:as range :keys [from to empty]}]\n                     (if empty\n                       {:range (or (some->> (n/nearest-touching state from -1)\n                                            (n/balanced-range state))\n                                   range)}\n                       {:range (or (some->> (grow-1 state from to)\n                                            n/range)\n                                   range)}))))\n\n(defn selection-return* [^js state]\n  (if-let [selection (:selection (second (stack state)))]\n    (.update state #js{:selection   selection\n                       :annotations event-annotation})\n    (u/update-ranges state\n                     #js{:annotations event-annotation}\n                     (fn [^js range] {:cursor (.-from range)}))))\n"]}